(()=>{"use strict";var e={4193:function(e,t,i){var r,s=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i);var s=Object.getOwnPropertyDescriptor(t,i);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,r,s)}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&s(t,e,i);return n(t,e),t},a=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(s,n){function o(e){try{d(r.next(e))}catch(e){n(e)}}function a(e){try{d(r.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}d((r=r.apply(e,t||[])).next())}))},d=this&&this.__classPrivateFieldSet||function(e,t,i,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,i):s?s.value=i:t.set(e,i),i},c=this&&this.__classPrivateFieldGet||function(e,t,i,r){if("a"===i&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?r:"a"===i?r.call(e):r?r.value:t.get(e)},u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.AccountService=t.SignTypedDataVersion=t.AccountImportStrategy=t.KeyringTypes=void 0;const h=i(9757),l=u(i(267)),f=i(9685),y=i(7567),g=o(i(3158)),v=i(2786);var p,w,m;!function(e){e.simple="Simple Key Pair",e.hd="HD Key Tree",e.qr="QR Hardware Wallet Device"}(p=t.KeyringTypes||(t.KeyringTypes={})),(m=t.AccountImportStrategy||(t.AccountImportStrategy={})).privateKey="privateKey",m.json="json",function(e){e.V1="V1",e.V3="V3",e.V4="V4"}(w=t.SignTypedDataVersion||(t.SignTypedDataVersion={}));class A extends v.AbstractService{constructor(){super(...arguments),this.name="AccountService",this.mutex=new h.Mutex,r.set(this,void 0)}initialize(e,t){d(this,r,new l.default(Object.assign({initState:t},e)),"f"),this.defaultState=Object.assign(Object.assign({},c(this,r,"f").store.getState()),{keyrings:[]}),c(this,r,"f").store.subscribe((e=>{this.updateState(e)})),this.fullUpdate()}addNewAccount(){return a(this,void 0,void 0,(function*(){const e=c(this,r,"f").getKeyringsByType("HD Key Tree")[0];if(!e)throw new Error("No HD keyring found");const t=yield c(this,r,"f").getAccounts();yield c(this,r,"f").addNewAccount(e);const i=yield c(this,r,"f").getAccounts();return yield this.verifySeedPhrase(),this.updateIdentities(i),i.forEach((e=>{t.includes(e)||this.setSelectedAddress(e)})),this.fullUpdate()}))}addNewAccountWithoutUpdate(){return a(this,void 0,void 0,(function*(){const e=c(this,r,"f").getKeyringsByType("HD Key Tree")[0];if(!e)throw new Error("No HD keyring found");return yield c(this,r,"f").addNewAccount(e),yield this.verifySeedPhrase(),this.fullUpdate()}))}createNewVaultAndKeychain(e){return a(this,void 0,void 0,(function*(){const t=yield this.mutex.acquire();try{const t=yield c(this,r,"f").createNewVaultAndKeychain(e);return this.updateIdentities(yield c(this,r,"f").getAccounts()),this.fullUpdate(),t}finally{t()}}))}updateIdentities(e){var t;const i=null===(t=this.manager)||void 0===t?void 0:t.getServiceByName("PreferencesService");i&&i.updateIdentities(e)}setSelectedAddress(e){var t;const i=null===(t=this.manager)||void 0===t?void 0:t.getServiceByName("PreferencesService");i&&i.setSelectedAddress(e)}setAccountLabel(e,t){var i;const r=null===(i=this.manager)||void 0===i?void 0:i.getServiceByName("PreferencesService");r&&r.setAccountLabel(e,t)}removeIdentity(e){var t;const i=null===(t=this.manager)||void 0===t?void 0:t.getServiceByName("PreferencesService");i&&i.removeIdentity(e)}syncIdentities(e){var t;const i=null===(t=this.manager)||void 0===t?void 0:t.getServiceByName("PreferencesService");i&&i.syncIdentities(e)}createNewVaultAndRestore(e,t){return a(this,void 0,void 0,(function*(){const i=yield this.mutex.acquire();if(!e||!e.length)throw new Error("Invalid password");try{this.updateIdentities([]);const i=yield c(this,r,"f").createNewVaultAndRestore(e,t);return this.updateIdentities(yield c(this,r,"f").getAccounts()),this.fullUpdate(),i}finally{i()}}))}validatePassword(e){return c(this,r,"f").password===e}isUnlocked(){return c(this,r,"f").memStore.getState().isUnlocked}exportSeedPhrase(e){if(this.validatePassword(e))return c(this,r,"f").keyrings[0].mnemonic;throw new Error("Invalid password")}exportAccount(e,t){if(this.validatePassword(e))return c(this,r,"f").exportAccount(t);throw new Error("Invalid password")}getAccounts(){return c(this,r,"f").getAccounts()}importAccountWithStrategy(e,t){return a(this,void 0,void 0,(function*(){let i;switch(e){case"privateKey":const[r]=t;if(!r)throw new Error("Cannot import an empty key.");const s=(0,y.addHexPrefix)(r);let n;try{n=(0,y.toBuffer)(s)}catch(e){throw new Error("Cannot import invalid private key.")}if(!(0,y.isValidPrivate)(n))throw new Error("Cannot import invalid private key.");i=(0,y.stripHexPrefix)(s);break;case"json":let o;const[a,d]=t;try{o=g.thirdparty.fromEtherWallet(a,d)}catch(e){o=o||(yield g.default.fromV3(a,d,!0))}i=(0,y.bufferToHex)(o.getPrivateKey());break;default:throw new Error(`Unexpected import strategy: '${e}'`)}const s=yield c(this,r,"f").addNewKeyring(p.simple,[i]),n=yield s.getAccounts(),o=yield c(this,r,"f").getAccounts();return this.updateIdentities(o),this.setSelectedAddress(n[0]),this.fullUpdate()}))}removeAccount(e){return a(this,void 0,void 0,(function*(){return this.removeIdentity(e),yield c(this,r,"f").removeAccount(e),this.fullUpdate()}))}setLocked(){return c(this,r,"f").setLocked()}signMessage(e){return c(this,r,"f").signMessage(e)}signPersonalMessage(e){return c(this,r,"f").signPersonalMessage(e)}signTypedMessage(e,t){return a(this,void 0,void 0,(function*(){try{const i=(0,f.normalize)(e.from),s=yield this.getOrAddQRKeyring();if(-1!==(yield s.getAccounts()).findIndex((e=>e.toLowerCase()===i.toLowerCase()))){const i=Object.assign({},e);return t!==w.V1&&"string"==typeof i.data&&(i.data=JSON.parse(i.data)),c(this,r,"f").signTypedMessage(i,{version:t})}const{password:n}=c(this,r,"f"),o=yield this.exportAccount(n,i),a=(0,y.toBuffer)((0,y.addHexPrefix)(o));switch(t){case w.V1:return(0,f.signTypedDataLegacy)(a,{data:e.data});case w.V3:return(0,f.signTypedData)(a,{data:JSON.parse(e.data)});case w.V4:return(0,f.signTypedData_v4)(a,{data:JSON.parse(e.data)});default:throw new Error(`Unexpected signTypedMessage version: '${t}'`)}}catch(e){throw new Error(`Keyring Controller signTypedMessage: ${e}`)}}))}signTransaction(e,t){return c(this,r,"f").signTransaction(e,t)}submitPassword(e){return a(this,void 0,void 0,(function*(){yield c(this,r,"f").submitPassword(e);const t=yield c(this,r,"f").getAccounts();return yield this.syncIdentities(t),this.fullUpdate()}))}onLock(e){return c(this,r,"f").on("lock",e)}onUnlock(e){return c(this,r,"f").on("unlock",e)}verifySeedPhrase(){return a(this,void 0,void 0,(function*(){const e=c(this,r,"f").getKeyringsByType(p.hd)[0];if(!e)throw new Error("No HD keyring found.");const t=(yield e.serialize()).mnemonic,i=yield e.getAccounts();if(0===i.length)throw new Error("Cannot verify an empty keyring.");const s=new(c(this,r,"f").getKeyringClassForType(p.hd))({mnemonic:t,numberOfAccounts:i.length}),n=yield s.getAccounts();if(n.length!==i.length)throw new Error("Seed phrase imported incorrect number of accounts.");return n.forEach(((e,t)=>{if(e.toLowerCase()!==i[t].toLowerCase())throw new Error("Seed phrase imported different accounts.")})),t}))}fullUpdate(){return a(this,void 0,void 0,(function*(){const e=yield Promise.all(c(this,r,"f").keyrings.map(((e,t)=>a(this,void 0,void 0,(function*(){const i=yield e.getAccounts();return{accounts:Array.isArray(i)?i.map((e=>this.toChecksumHexAddress(e))):[],index:t,type:e.type}})))));return this.updateState({keyrings:[...e]}),c(this,r,"f").fullUpdate()}))}addQRKeyring(){return a(this,void 0,void 0,(function*(){const e=yield c(this,r,"f").addNewKeyring(p.qr);return yield this.fullUpdate(),e}))}getOrAddQRKeyring(){return a(this,void 0,void 0,(function*(){return c(this,r,"f").getKeyringsByType(p.qr)[0]||this.addQRKeyring()}))}restoreQRKeyring(e){return a(this,void 0,void 0,(function*(){(yield this.getOrAddQRKeyring()).deserialize(e),this.updateIdentities(yield c(this,r,"f").getAccounts()),yield this.fullUpdate()}))}resetQRKeyringState(){return a(this,void 0,void 0,(function*(){(yield this.getOrAddQRKeyring()).resetStore()}))}getQRKeyringState(){return a(this,void 0,void 0,(function*(){return(yield this.getOrAddQRKeyring()).getMemStore()}))}submitQRCryptoHDKey(e){return a(this,void 0,void 0,(function*(){(yield this.getOrAddQRKeyring()).submitCryptoHDKey(e)}))}submitQRCryptoAccount(e){return a(this,void 0,void 0,(function*(){(yield this.getOrAddQRKeyring()).submitCryptoAccount(e)}))}submitQRSignature(e,t){return a(this,void 0,void 0,(function*(){(yield this.getOrAddQRKeyring()).submitSignature(e,t)}))}cancelQRSignRequest(){return a(this,void 0,void 0,(function*(){(yield this.getOrAddQRKeyring()).cancelSignRequest()}))}connectQRHardware(e){return a(this,void 0,void 0,(function*(){try{const t=yield this.getOrAddQRKeyring();let i;switch(e){case-1:i=yield t.getPreviousPage();break;case 1:i=yield t.getNextPage();break;default:i=yield t.getFirstPage()}return i.map((e=>Object.assign(Object.assign({},e),{balance:"0x0"})))}catch(e){throw new Error(`Unspecified error when connect QR Hardware, ${e}`)}}))}unlockQRHardwareWalletAccount(e){return a(this,void 0,void 0,(function*(){const t=yield this.getOrAddQRKeyring();t.setAccountToUnlock(e);const i=yield c(this,r,"f").getAccounts();yield c(this,r,"f").addNewAccount(t);const s=yield c(this,r,"f").getAccounts();this.updateIdentities(s),s.forEach((r=>{i.includes(r)||(this.setAccountLabel&&this.setAccountLabel(r,`${t.getName()} ${e}`),this.setSelectedAddress(r))})),yield c(this,r,"f").persistAllKeyrings(),yield this.fullUpdate()}))}getAccountKeyringType(e){return a(this,void 0,void 0,(function*(){return(yield c(this,r,"f").getKeyringForAccount(e)).type}))}forgetQRDevice(){return a(this,void 0,void 0,(function*(){(yield this.getOrAddQRKeyring()).forgetDevice(),(yield c(this,r,"f").getAccounts()).forEach((e=>{this.setSelectedAddress(e)})),yield c(this,r,"f").persistAllKeyrings(),yield this.fullUpdate()}))}toChecksumHexAddress(e){const t=(0,y.addHexPrefix)(e);return(0,y.isHexString)(t)?(0,y.toChecksumAddress)(t):t}}t.AccountService=A,r=new WeakMap,t.default=A},2786:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AbstractService=void 0;class i{constructor(){this.name="IService",this.defaultState={},this._state=this.defaultState}get manager(){return this._manager}set manager(e){this._manager=e}set adapter(e){this._adapter=e;const t=null==e?void 0:e.defaultState;t&&(this.defaultState=Object.assign(Object.assign({},this.defaultState),t)),this._state=Object.assign(Object.assign({},this._state),this.defaultState)}get adapter(){return this._adapter}getState(){return this._state}updateState(e={}){this._adapter&&(this._state=Object.assign(Object.assign({},this._state),e),this._adapter.onStateUpdate(this._state,this.name),this._adapter.listeners.forEach((e=>{e&&e(Object.assign({},this._state),this.name)})))}publish(e,t){var i;const r=null===(i=this._manager)||void 0===i?void 0:i.subscribers;if(r){const i=r.get(e);i&&i.forEach((i=>{i(e,t)}))}}}t.AbstractService=i,t.default=i},9757:e=>{e.exports=require("async-mutex")},267:e=>{e.exports=require("eth-keyring-controller")},9685:e=>{e.exports=require("eth-sig-util")},7567:e=>{e.exports=require("ethereumjs-util")},3158:e=>{e.exports=require("ethereumjs-wallet")}},t={};!function i(r){var s=t[r];if(void 0!==s)return s.exports;var n=t[r]={exports:{}};return e[r].call(n.exports,n,n.exports,i),n.exports}(4193)})();