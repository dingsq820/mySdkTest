{"version":3,"file":"ConnectionStream.js","sourceRoot":"","sources":["../../src/web3/ConnectionStream.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable func-names */\nimport { Buffer } from 'buffer';\nimport ObjectMultiplex from 'obj-multiplex';\nimport pump from 'pump';\nimport { Duplex } from 'readable-stream';\nimport Through from 'through2';\n\n// eslint-disable-next-line no-empty-function\nconst noop = () => {};\n\nexport default class ConnectionStream extends Duplex {\n  _port: any;\n\n  _url: any;\n\n  constructor(port: any, url: any) {\n    super({\n      objectMode: true,\n    });\n    this._port = port;\n    this._url = url;\n    this._port.addListener('message', this._onMessage.bind(this));\n    this._port.addListener('disconnect', this._onDisconnect.bind(this));\n  }\n\n  /**\n   * Callback triggered when a message is received from\n   * the remote Port associated with this Stream.\n   *\n   * @private\n   * @param {Object} msg - Payload from the onMessage listener of Port\n   */\n  _onMessage(this: any, msg: any) {\n    if (Buffer.isBuffer(msg)) {\n      // @ts-expect-error TS(2339): Property '_isBuffer' does not exist on type 'Buffe... Remove this comment to see the full error message\n      delete msg._isBuffer;\n      const data = new Buffer(msg);\n      this.push(data);\n    } else {\n      this.push(msg);\n    }\n  }\n\n  /**\n   * Callback triggered when the remote Port\n   * associated with this Stream disconnects.\n   *\n   * @private\n   */\n  _onDisconnect(this: any) {\n    this.destroy && this.destroy();\n  }\n\n  /**\n   * Explicitly sets read operations to a no-op\n   */\n  _read = noop;\n\n  /**\n   * Called internally when data should be written to\n   * this writable stream.\n   *\n   * @private\n   * @param {*} msg Arbitrary object to write\n   * @param {string} encoding Encoding to use when writing payload\n   * @param {Function} cb Called when writing is complete or an error occurs\n   */\n  _write(this: any, msg: any, encoding: any, cb: any): any {\n    try {\n      if (Buffer.isBuffer(msg)) {\n        const data = msg.toJSON();\n        // @ts-expect-error TS(2339): Property '_isBuffer' does not exist on type '{ typ... Remove this comment to see the full error message\n        data._isBuffer = true;\n        this._port.postMessage(data, this._url);\n      } else {\n        this._port.postMessage(msg, this._url);\n      }\n    } catch (err) {\n      return cb(new Error('ConnectionStream - disconnected'));\n    }\n    return cb();\n  }\n}\n/**\n * Returns a stream transform that parses JSON strings passing through\n * @return {stream.Transform}\n */\nfunction jsonParseStream() {\n  return Through.obj(function (this: any, serialized: any, _: any, cb: any) {\n    this.push(JSON.parse(serialized));\n    cb();\n  });\n}\n\n/**\n * Returns a stream transform that calls {@code JSON.stringify}\n * on objects passing through\n * @return {stream.Transform} the stream transform\n */\nfunction jsonStringifyStream() {\n  return Through.obj(function (this: any, obj: any, _: any, cb: any) {\n    this.push(JSON.stringify(obj));\n    cb();\n  });\n}\n\n/**\n * Sets up stream multiplexing for the given stream\n * @param {any} connectionStream - the stream to mux\n * @return {stream.Stream} the multiplexed stream\n */\nfunction setupMultiplex(connectionStream: any) {\n  const mux = new ObjectMultiplex();\n  pump(connectionStream, mux, connectionStream, (err: any) => {\n    if (err) {\n      console.warn(err);\n    }\n  });\n  return mux;\n}\n\nexport { ConnectionStream, jsonParseStream, jsonStringifyStream, setupMultiplex };\n"]}